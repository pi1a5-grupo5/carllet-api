ªN
+D:\_lab\carllet-mvp\Services\AuthService.cs
	namespace

 	
Services


 
{ 
public 

class 
AuthService 
: 
IAuthService +
{ 
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
private 
CarlletDbContext  

_dbContext! +
;+ ,
public 
AuthService 
( 
IConfiguration )
configuration* 7
,7 8
CarlletDbContext9 I
	dbContextJ S
)S T
{ 	

_dbContext 
= 
	dbContext "
;" #
_configuration 
= 
configuration *
;* +
} 	
public 
async 
Task 
< 
string  
>  !
GenerateAccessToken" 5
(5 6
User6 :
user; ?
)? @
{ 	
var 
tokenHandler 
= 
new "#
JwtSecurityTokenHandler# :
(: ;
); <
;< =
var 
key 
= 
Encoding 
. 
ASCII $
.$ %
GetBytes% -
(- .
_configuration. <
[< =
$str= E
]E F
)F G
;G H
var 
expires 
= 
DateTime "
." #
UtcNow# )
.) *

AddMinutes* 4
(4 5
Convert5 <
.< =
ToDouble= E
(E F
_configurationF T
[T U
$strU s
]s t
)t u
)u v
;v w
var 
tokenDescriptor 
=  !
new" %#
SecurityTokenDescriptor& =
{ 
Subject 
= 
new 
ClaimsIdentity ,
(, -
new- 0
[0 1
]1 2
{   
new!! 
Claim!! 
(!! 

ClaimTypes!! (
.!!( )
Name!!) -
,!!- .
user!!/ 3
.!!3 4
Id!!4 6
.!!6 7
ToString!!7 ?
(!!? @
)!!@ A
)!!A B
}"" 
)"" 
,"" 
Expires## 
=## 
expires## !
,##! "
SigningCredentials$$ "
=$$# $
new$$% (
SigningCredentials$$) ;
($$; <
new$$< ? 
SymmetricSecurityKey$$@ T
($$T U
key$$U X
)$$X Y
,$$Y Z
SecurityAlgorithms$$[ m
.$$m n 
HmacSha256Signature	$$n 
)
$$ ‚
}%% 
;%% 
var'' 
token'' 
='' 
tokenHandler'' $
.''$ %
CreateToken''% 0
(''0 1
tokenDescriptor''1 @
)''@ A
;''A B
var(( 
accessToken(( 
=(( 
tokenHandler(( *
.((* +

WriteToken((+ 5
(((5 6
token((6 ;
)((; <
;((< =
var** 

updateUser** 
=** 

_dbContext** '
.**' (
User**( ,
.**, -
SingleOrDefault**- <
(**< =
u**= >
=>**? A
u**B C
.**C D
Id**D F
==**G I
user**J N
.**N O
Id**O Q
)**Q R
;**R S
if,, 
(,, 

updateUser,, 
==,, 
null,, "
),," #
{-- 
return.. 
null.. 
;.. 
}// 

updateUser11 
.11 
AccessToken11 "
=11# $
accessToken11% 0
;110 1

updateUser22 
.22 !
AccessTokenExpiration22 ,
=22- .
expires22/ 6
;226 7

_dbContext33 
.33 
SaveChanges33 "
(33" #
)33# $
;33$ %
return55 

updateUser55 
.55 
AccessToken55 )
;55) *
}66 	
public88 
async88 
Task88 
<88 
string88  
>88  ! 
GenerateRefreshToken88" 6
(886 7
User887 ;
user88< @
)88@ A
{99 	
var:: 
tokenHandler:: 
=:: 
new:: "#
JwtSecurityTokenHandler::# :
(::: ;
)::; <
;::< =
var;; 
key;; 
=;; 
Encoding;; 
.;; 
ASCII;; $
.;;$ %
GetBytes;;% -
(;;- .
_configuration;;. <
[;;< =
$str;;= E
];;E F
);;F G
;;;G H
var<< 
expires<< 
=<< 
DateTime<< "
.<<" #
UtcNow<<# )
.<<) *

AddMinutes<<* 4
(<<4 5
Convert<<5 <
.<<< =
ToDouble<<= E
(<<E F
_configuration<<F T
[<<T U
$str<<U t
]<<t u
)<<u v
)<<v w
;<<w x
var>> 
tokenDescriptor>> 
=>>  !
new>>" %#
SecurityTokenDescriptor>>& =
{?? 
Subject@@ 
=@@ 
new@@ 
ClaimsIdentity@@ ,
(@@, -
new@@- 0
[@@0 1
]@@1 2
{AA 
newBB 
ClaimBB 
(BB 

ClaimTypesBB (
.BB( )
NameBB) -
,BB- .
userBB/ 3
.BB3 4
IdBB4 6
.BB6 7
ToStringBB7 ?
(BB? @
)BB@ A
)BBA B
}CC 
)CC 
,CC 
ExpiresDD 
=DD 
expiresDD !
,DD! "
SigningCredentialsEE "
=EE# $
newEE% (
SigningCredentialsEE) ;
(EE; <
newEE< ? 
SymmetricSecurityKeyEE@ T
(EET U
keyEEU X
)EEX Y
,EEY Z
SecurityAlgorithmsEE[ m
.EEm n 
HmacSha256Signature	EEn 
)
EE ‚
}FF 
;FF 
varHH 
tokenHH 
=HH 
tokenHandlerHH $
.HH$ %
CreateTokenHH% 0
(HH0 1
tokenDescriptorHH1 @
)HH@ A
;HHA B
varII 
refreshTokenII 
=II 
tokenHandlerII +
.II+ ,

WriteTokenII, 6
(II6 7
tokenII7 <
)II< =
;II= >
varKK 

updateUserKK 
=KK 

_dbContextKK '
.KK' (
UserKK( ,
.KK, -
SingleOrDefaultKK- <
(KK< =
uKK= >
=>KK? A
uKKB C
.KKC D
IdKKD F
==KKG I
userKKJ N
.KKN O
IdKKO Q
)KKQ R
;KKR S
ifMM 
(MM 

updateUserMM 
==MM 
nullMM "
)MM" #
{NN 
returnOO 
nullOO 
;OO 
}PP 

updateUserRR 
.RR 
RefreshTokenRR #
=RR$ %
refreshTokenRR& 2
;RR2 3

updateUserSS 
.SS "
RefreshTokenExpirationSS -
=SS. /
expiresSS0 7
;SS7 8

_dbContextTT 
.TT 
SaveChangesTT "
(TT" #
)TT# $
;TT$ %
returnVV 

updateUserVV 
.VV 
RefreshTokenVV *
;VV* +
}WW 	
publicYY 
asyncYY 
TaskYY 
<YY 
intYY 
?YY 
>YY 
ValidateTokenYY  -
(YY- .
stringYY. 4
tokenYY5 :
)YY: ;
{ZZ 	
if[[ 
([[ 
token[[ 
==[[ 
null[[ 
)[[ 
return\\ 
null\\ 
;\\ 
var^^ 
tokenHandler^^ 
=^^ 
new^^ "#
JwtSecurityTokenHandler^^# :
(^^: ;
)^^; <
;^^< =
var__ 
key__ 
=__ 
Encoding__ 
.__ 
ASCII__ $
.__$ %
GetBytes__% -
(__- .
_configuration__. <
[__< =
$str__= L
]__L M
)__M N
;__N O
try`` 
{aa 
tokenHandlerbb 
.bb 
ValidateTokenbb *
(bb* +
tokenbb+ 0
,bb0 1
newbb2 5%
TokenValidationParametersbb6 O
{cc $
ValidateIssuerSigningKeydd ,
=dd- .
truedd/ 3
,dd3 4
IssuerSigningKeyee $
=ee% &
newee' * 
SymmetricSecurityKeyee+ ?
(ee? @
keyee@ C
)eeC D
,eeD E
ValidateIssuerff "
=ff# $
falseff% *
,ff* +
ValidateAudiencegg $
=gg% &
falsegg' ,
,gg, -
	ClockSkewhh 
=hh 
TimeSpanhh  (
.hh( )
Zerohh) -
}ii 
,ii 
outii 
SecurityTokenii $
validatedTokenii% 3
)ii3 4
;ii4 5
varkk 
jwtTokenkk 
=kk 
(kk  
JwtSecurityTokenkk  0
)kk0 1
validatedTokenkk1 ?
;kk? @
varll 
userIdll 
=ll 
intll  
.ll  !
Parsell! &
(ll& '
jwtTokenll' /
.ll/ 0
Claimsll0 6
.ll6 7
Firstll7 <
(ll< =
xll= >
=>ll? A
xllB C
.llC D
TypellD H
==llI K
$strllL P
)llP Q
.llQ R
ValuellR W
)llW X
;llX Y
returnnn 
userIdnn 
;nn 
}oo 
catchpp 
{qq 
returnrr 
nullrr 
;rr 
}ss 
}tt 	
}uu 
}vv š
-D:\_lab\carllet-mvp\Services\CourseService.cs
	namespace 	
Services
 
{ 
public 

class 
CourseService 
:  
ICourseService! /
{ 
private		 
readonly		 
CarlletDbContext		 )

_dbContext		* 4
;		4 5
public 
CourseService 
( 
CarlletDbContext -
	dbContext. 7
)7 8
{ 	

_dbContext 
= 
	dbContext "
;" #
} 	
public 
async 
Task 
< 
List 
< 
Course %
>% &
>& '
GetByUserId( 3
(3 4
Guid4 8
driverId9 A
)A B
{ 	
var 
courses 
= 

_dbContext $
.$ %
Course% +
.+ ,
Where, 1
(1 2
u2 3
=>4 6
u7 8
.8 9
OwnerId9 @
==A C
driverIdD L
)L M
.M N
ToListN T
(T U
)U V
;V W
if 
( 
courses 
== 
null 
||  "
courses# *
.* +
Count+ 0
==1 3
$num4 5
)5 6
{ 
return 
null 
; 
} 
return 
courses 
; 
} 	
public 
async 
Task 
< 
Course  
>  !
Register" *
(* +
Course+ 1
course2 8
)8 9
{ 	
User   
user   
=   

_dbContext   "
.  " #
User  # '
.  ' (
FirstOrDefault  ( 6
(  6 7
u  7 8
=>  9 ;
u  < =
.  = >
Id  > @
==  A C
course  D J
.  J K
OwnerId  K R
)  R S
;  S T
course"" 
."" 
Owner"" 
="" 
user"" 
;""  
var$$ 
	setCourse$$ 
=$$ 

_dbContext$$ &
.$$& '
Course$$' -
.$$- .
Add$$. 1
($$1 2
course$$2 8
)$$8 9
;$$9 :
if&& 
(&& 
	setCourse&& 
==&& 
null&& !
)&&! "
{'' 
return(( 
null(( 
;(( 
})) 

_dbContext++ 
.++ 
SaveChanges++ "
(++" #
)++# $
;++$ %
return-- 
course-- 
;-- 
}.. 	
}11 
}22 ø"
.D:\_lab\carllet-mvp\Services\EarningService.cs
	namespace 	
Services
 
{ 
public 

class 
EarningService 
:  !
IEarningService" 1
{		 
private 
readonly 
CarlletDbContext )

_dbContext* 4
;4 5
public 
EarningService 
( 
CarlletDbContext .
	dbContext/ 8
)8 9
{ 	

_dbContext 
= 
	dbContext "
;" #
} 	
public 
async 
Task 
< 
Earning !
>! "
DeleteEarning# 0
(0 1
Guid1 5
Id6 8
)8 9
{ 	
throw 
new #
NotImplementedException -
(- .
). /
;/ 0
} 	
public 
async 
Task 
< 
List 
< 
Earning &
>& '
>' (
GetEarningByUser) 9
(9 :
Guid: >
driver? E
,E F
DateTimeG O
StartSearchP [
,[ \
DateTime] e
	EndSearchf o
)o p
{ 	
var 
earnings 
= 

_dbContext %
.% &
Earning& -
.- .
Where. 3
(3 4
u4 5
=>6 8
u9 :
.: ;
OwnerId; B
==C E
driverF L
&& 
u 
. 
InsertionDateTime "
<=# %
StartSearch& 1
&& 
u 
. 
InsertionDateTime "
>=# %
	EndSearch& /
)/ 0
.0 1
ToList1 7
(7 8
)8 9
;9 :
if 
( 
earnings 
== 
null  
||! #
earnings$ ,
., -
Count- 2
==3 5
$num6 7
)7 8
{ 
return 
null 
; 
} 
return   
earnings   
;   
}!! 	
public## 
async## 
Task## 
<## 
List## 
<## 
Earning## &
>##& '
>##' (
GetEarningByUser##) 9
(##9 :
Guid##: >
driver##? E
)##E F
{$$ 	
var%% 
earnings%% 
=%% 

_dbContext%% %
.%%% &
Earning%%& -
.%%- .
Where%%. 3
(%%3 4
u%%4 5
=>%%6 8
u%%9 :
.%%: ;
OwnerId%%; B
==%%C E
driver%%F L
)%%L M
.%%M N
ToList%%N T
(%%T U
)%%U V
;%%V W
if'' 
('' 
earnings'' 
=='' 
null''  
||''! #
earnings''$ ,
.'', -
Count''- 2
==''3 5
$num''6 7
)''7 8
{(( 
return)) 
null)) 
;)) 
}** 
return,, 
earnings,, 
;,, 
}-- 	
public// 
async// 
Task// 
<// 
Earning// !
>//! "
RegisterEarning//# 2
(//2 3
Earning//3 :
earning//; B
)//B C
{00 	
User11 
user11 
=11 

_dbContext11 "
.11" #
User11# '
.11' (
FirstOrDefault11( 6
(116 7
u117 8
=>119 ;
u11< =
.11= >
Id11> @
==11A C
earning11D K
.11K L
OwnerId11L S
)11S T
;11T U
earning33 
.33 
Owner33 
=33 
user33  
;33  !
var55 

setEarning55 
=55 

_dbContext55 '
.55' (
Earning55( /
.55/ 0
Add550 3
(553 4
earning554 ;
)55; <
;55< =
if77 
(77 

setEarning77 
==77 
null77 "
)77" #
{88 
return99 
null99 
;99 
}:: 
return<< 
earning<< 
;<< 
}== 	
}>> 
}?? ò?
+D:\_lab\carllet-mvp\Services\UserService.cs
	namespace 	
Services
 
{ 
public 

class 
UserService 
: 
IUserService +
{ 
private		 
readonly		 
CarlletDbContext		 )

_dbContext		* 4
;		4 5
private

 
IAuthService

 
_authService

 )
;

) *
public 
UserService 
( 
CarlletDbContext +
	dbContext, 5
,5 6
IAuthService7 C
authServiceD O
)O P
{ 	

_dbContext 
= 
	dbContext "
;" #
_authService 
= 
authService &
;& '
} 	
public 
async 
Task 
< 
User 
> 

DeleteUser  *
(* +
Guid+ /
id0 2
)2 3
{ 	
var 
user 
= 

_dbContext !
.! "
User" &
.& '
Where' ,
(, -
u- .
=>/ 1
u2 3
.3 4
Id4 6
==7 9
id: <
)< =
.= >
FirstOrDefault> L
(L M
)M N
;N O
if 
( 
user 
== 
null 
) 
{ 
return 
null 
; 
} 

_dbContext 
. 
User 
. 
Remove "
(" #
user# '
)' (
;( )

_dbContext 
. 
SaveChanges "
(" #
)# $
;$ %
user 
. 
Password 
= 
$str 
; 
return 
user 
; 
}!! 	
public## 
async## 
Task## 
<## 
List## 
<## 
User## #
>### $
>##$ %
GetUserList##& 1
(##1 2
)##2 3
{$$ 	
var%% 
users%% 
=%% 

_dbContext%% "
.%%" #
User%%# '
.%%' (
ToList%%( .
(%%. /
)%%/ 0
;%%0 1
if(( 
((( 
users(( 
.(( 
Count(( 
==(( 
$num((  
)((  !
{)) 
return** 
null** 
;** 
}++ 
return-- 
users-- 
;-- 
}.. 	
public00 
async00 
Task00 
<00 
User00 
>00 
GetUser00  '
(00' (
Guid00( ,
id00- /
)00/ 0
{11 	
var22 
user22 
=22 

_dbContext22 !
.22! "
User22" &
.22& '
Find22' +
(22+ ,
id22, .
)22. /
;22/ 0
if44 
(44 
user44 
==44 
null44 
)44 
{55 
return66 
null66 
;66 
}77 
return99 
user99 
;99 
}:: 	
public== 
async== 
Task== 
<== 
User== 
>== 
Register==  (
(==( )
User==) -
user==. 2
)==2 3
{>> 	
var?? 
	userExist?? 
=?? 

_dbContext?? &
.??& '
User??' +
.??+ ,
FirstOrDefault??, :
(??: ;
u??; <
=>??= ?
u??@ A
.??A B
Email??B G
==??H J
user??K O
.??O P
Email??P U
)??U V
;??V W
ifAA 
(AA 
	userExistAA 
!=AA 
nullAA !
)AA! "
{BB 
returnCC 
nullCC 
;CC 
}DD 
userFF 
.FF 
PasswordFF 
=FF 
BCryptFF "
.FF" #
NetFF# &
.FF& '
BCryptFF' -
.FF- .
HashPasswordFF. :
(FF: ;
userFF; ?
.FF? @
PasswordFF@ H
)FFH I
;FFI J
varHH 
setUserHH 
=HH 

_dbContextHH $
.HH$ %
UserHH% )
.HH) *
AddHH* -
(HH- .
userHH. 2
)HH2 3
;HH3 4
ifJJ 
(JJ 
setUserJJ 
==JJ 
nullJJ 
)JJ  
{KK 
returnLL 
nullLL 
;LL 
}MM 

_dbContextOO 
.OO 
SaveChangesOO "
(OO" #
)OO# $
;OO$ %
userQQ 
.QQ 
AccessTokenQQ 
=QQ 
awaitQQ $
_authServiceQQ% 1
.QQ1 2
GenerateAccessTokenQQ2 E
(QQE F
userQQF J
)QQJ K
;QQK L
userRR 
.RR 
RefreshTokenRR 
=RR 
awaitRR  %
_authServiceRR& 2
.RR2 3 
GenerateRefreshTokenRR3 G
(RRG H
userRRH L
)RRL M
;RRM N
userTT 
.TT 
PasswordTT 
=TT 
nullTT  
;TT  !
returnVV 
userVV 
;VV 
}WW 	
publicXX 
asyncXX 
TaskXX 
<XX 
UserXX 
>XX 
LoginXX  %
(XX% &
stringXX& ,
emailXX- 2
,XX2 3
stringXX4 :
passwordXX; C
)XXC D
{YY 	
varZZ 
userZZ 
=ZZ 

_dbContextZZ !
.ZZ! "
UserZZ" &
.ZZ& '
FirstOrDefaultZZ' 5
(ZZ5 6
uZZ6 7
=>ZZ8 :
uZZ; <
.ZZ< =
EmailZZ= B
==ZZC E
emailZZF K
)ZZK L
;ZZL M
if\\ 
(\\ 
user\\ 
==\\ 
null\\ 
)\\ 
{]] 
return^^ 
null^^ 
;^^ 
}__ 
boolaa 
correctPasswordaa  
=aa! "
BCryptaa# )
.aa) *
Netaa* -
.aa- .
BCryptaa. 4
.aa4 5
Verifyaa5 ;
(aa; <
passwordaa< D
,aaD E
useraaF J
.aaJ K
PasswordaaK S
)aaS T
;aaT U
ifcc 
(cc 
!cc 
correctPasswordcc  
)cc  !
{dd 
returnee 
nullee 
;ee 
}ff 
userhh 
.hh 
Passwordhh 
=hh 
$strhh 
;hh 
returnjj 
userjj 
;jj 
}kk 	
publicmm 
asyncmm 
Taskmm 
<mm 
Usermm 
>mm 
Updatemm  &
(mm& '
Usermm' +
usermm, 0
)mm0 1
{nn 	
varpp 
userToUpdatepp 
=pp 

_dbContextpp )
.pp) *
Userpp* .
.pp. /
Findpp/ 3
(pp3 4
userpp4 8
.pp8 9
Idpp9 ;
)pp; <
;pp< =
ifqq 
(qq 
userToUpdateqq 
==qq 
nullqq  $
)qq$ %
{rr 
returnss 
nullss 
;ss 
}tt 

_dbContextww 
.ww 
Entryww 
(ww 
userToUpdateww )
)ww) *
.ww* +
CurrentValuesww+ 8
.ww8 9
	SetValuesww9 B
(wwB C
userwwC G
)wwG H
;wwH I
awaitxx 

_dbContextxx 
.xx 
SaveChangesAsyncxx -
(xx- .
)xx. /
;xx/ 0
userToUpdatezz 
.zz 
Passwordzz !
=zz" #
$strzz$ &
;zz& '
return|| 
userToUpdate|| 
;||  
}}} 	
}~~ 
} ¢ 
.D:\_lab\carllet-mvp\Services\VehicleService.cs
	namespace 	
Services
 
{ 
public 

class 
VehicleService 
:  !
IVehicleService" 1
{ 
private		 
readonly		 
CarlletDbContext		 )

_dbContext		* 4
;		4 5
public 
VehicleService 
( 
CarlletDbContext .
	dbContext/ 8
)8 9
{ 	

_dbContext 
= 
	dbContext "
;" #
} 	
public 
async 
Task 
< 
Vehicle !
>! "
CreateVehicle# 0
(0 1
Vehicle1 8
vehicle9 @
)@ A
{ 	
var 

setVehicle 
= 

_dbContext '
.' (
Vehicle( /
./ 0
Add0 3
(3 4
vehicle4 ;
); <
;< =
if 
( 

setVehicle 
== 
null "
)" #
{ 
return 
null 
; 
} 

_dbContext 
. 
SaveChanges "
(" #
)# $
;$ %
return 
vehicle 
; 
} 	
public 
async 
Task 
< 
Vehicle !
>! "
DeleteVehicle# 0
(0 1
int1 4
id5 7
)7 8
{ 	
var   
vehicle   
=   

_dbContext   $
.  $ %
Vehicle  % ,
.  , -
Find  - 1
(  1 2
id  2 4
)  4 5
;  5 6
if"" 
("" 
vehicle"" 
=="" 
null"" 
)""  
{## 
return$$ 
null$$ 
;$$ 
}%% 

_dbContext'' 
.'' 
Vehicle'' 
.'' 
Remove'' %
(''% &
vehicle''& -
)''- .
;''. /

_dbContext(( 
.(( 
SaveChanges(( "
(((" #
)((# $
;(($ %
return** 
vehicle** 
;** 
}++ 	
public-- 
async-- 
Task-- 
<-- 
Vehicle-- !
>--! "
GetVehicleById--# 1
(--1 2
int--2 5
id--6 8
)--8 9
{.. 	
var// 
vehicle// 
=// 

_dbContext// $
.//$ %
Vehicle//% ,
.//, -
Find//- 1
(//1 2
id//2 4
)//4 5
;//5 6
if11 
(11 
vehicle11 
==11 
null11 
)11  
{22 
return33 
null33 
;33 
}44 
return66 
vehicle66 
;66 
}77 	
public99 
Task99 
<99 
List99 
<99 
Vehicle99  
>99  !
>99! "
GetVehicleByOwner99# 4
(994 5
Guid995 9
userId99: @
)99@ A
{:: 	
throw;; 
new;; #
NotImplementedException;; -
(;;- .
);;. /
;;;/ 0
}<< 	
publicLL 
asyncLL 
TaskLL 
<LL 
ListLL 
<LL 
VehicleLL &
>LL& '
>LL' (
GetVehicleListLL) 7
(LL7 8
)LL8 9
{MM 	
varNN 
vehiclesNN 
=NN 

_dbContextNN %
.NN% &
VehicleNN& -
.NN- .
ToListNN. 4
(NN4 5
)NN5 6
;NN6 7
ifQQ 
(QQ 
vehiclesQQ 
.QQ 
CountQQ 
==QQ !
$numQQ" #
)QQ# $
{RR 
returnSS 
nullSS 
;SS 
}TT 
returnVV 
vehiclesVV 
;VV 
}WW 	
}XX 
}YY 