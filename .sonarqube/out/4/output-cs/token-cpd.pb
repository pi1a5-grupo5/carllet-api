£
ED:\_lab\carllet-mvp\Application\ActionFilter\TokenValidationFilter.cs
	namespace 	
Application
 
. 
ActionFilter "
{ 
public 

class !
TokenValidationFilter &
:' (
IActionFilter) 6
{ 
public 
void 
OnActionExecuted $
($ %!
ActionExecutedContext% :
context; B
)B C
{		 	
var

 
accessToken

 
=

 
context

 %
.

% &
HttpContext

& 1
.

1 2
Request

2 9
.

9 :
Headers

: A
[

A B
$str

B Q
]

Q R
.

R S
ToString

S [
(

[ \
)

\ ]
;

] ^
if 
( 
string 
. 
IsNullOrEmpty $
($ %
accessToken% 0
)0 1
)1 2
{ 
context 
. 
Result 
=  
new! $"
BadRequestObjectResult% ;
(; <
$str< W
)W X
;X Y
return 
; 
} 
bool 
isTokenValid 
= 
ValidateToken  -
(- .
accessToken. 9
)9 :
;: ;
if 
( 
! 
isTokenValid 
) 
{ 
context 
. 
Result 
=  
new! $$
UnauthorizedObjectResult% =
(= >
$str> N
)N O
;O P
return 
; 
} 
} 	
public 
void 
OnActionExecuting %
(% &"
ActionExecutingContext& <
context= D
)D E
{ 	
throw 
new #
NotImplementedException -
(- .
). /
;/ 0
}   	
private!! 
bool!! 
ValidateToken!! "
(!!" #
string!!# )
accessToken!!* 5
)!!5 6
{"" 	
throw## 
new## #
NotImplementedException## -
(##- .
)##. /
;##/ 0
}$$ 	
}%% 
}&& Ô
?D:\_lab\carllet-mvp\Application\Controllers\CourseController.cs
	namespace 	
Application
 
. 
Controllers !
{ 
[ 
Route 

(
 
$str 
) 
] 
[		 
ApiController		 
]		 
public

 

class

 
CourseController

 !
:

" #
ControllerBase

$ 2
{ 
private 
readonly 
ICourseService '
_courseService( 6
;6 7
public 
CourseController 
(  
ICourseService  .
courseService/ <
)< =
{ 	
_courseService 
= 
courseService *
;* +
} 	
[ 	
HttpPost	 
] 
public 
async 
Task 
< 
IActionResult '
>' (
Post) -
(- .
[. /
FromBody/ 7
]7 8
NewCourseRequest9 I
requestJ Q
)Q R
{ 	
Course   
course   
=   
new   
Course    &
(  & '
)  ' (
{!! 
CourseEndTime"" 
="" 
request""  '
.""' (
CourseEndTime""( 5
,""5 6
CourseLength## 
=## 
request## &
.##& '
CourseLength##' 3
,##3 4
OwnerId$$ 
=$$ 
request$$ !
.$$! "
OwnerId$$" )
,$$) *
}%% 
;%% 
var(( 
result(( 
=(( 
await(( 
_courseService(( -
.((- .
Register((. 6
(((6 7
course((7 =
)((= >
;((> ?
return** 
Ok** 
(** 
result** 
)** 
;** 
}++ 	
[77 	
HttpGet77	 
(77 
$str77 +
)77+ ,
]77, -
public88 
async88 
Task88 
<88 
IActionResult88 '
>88' (
GetByUserId88) 4
(884 5
Guid885 9
driverId88: B
)88B C
{99 	
var;; 
result;; 
=;; 
await;; 
_courseService;; -
.;;- .
GetByUserId;;. 9
(;;9 :
driverId;;: B
);;B C
;;;C D
return== 
Ok== 
(== 
result== 
)== 
;== 
}>> 	
}?? 
}@@ ®
@D:\_lab\carllet-mvp\Application\Controllers\EarningController.cs
	namespace 	
Application
 
. 
Controllers !
{		 
[

 
Route

 

(


 
$str

 
)

 
]

 
[ 
ApiController 
] 
public 

class 
EarningController "
:# $
ControllerBase% 3
{ 
private 
readonly 
IEarningService (
_earningService) 8
;8 9
public 
EarningController  
(  !
IEarningService! 0
earningService1 ?
)? @
{ 	
_earningService 
= 
earningService ,
;, -
} 	
[ 	
HttpGet	 
( 
$str 
) 
] 
public 
async 
Task 
< 
IActionResult '
>' (

GetEarning) 3
(3 4
Guid4 8
Id9 ;
); <
{ 	
var 
result 
= 
await 
_earningService .
.. /
GetEarningByUser/ ?
(? @
Id@ B
)B C
;C D
if 
( 
result 
== 
null 
) 
{ 
return 
NotFound 
(  
)  !
;! "
} 
return 
Ok 
( 
result 
) 
; 
}   	
["" 	
HttpPost""	 
]"" 
public## 
async## 
Task## 
<## 
IActionResult## '
>##' (
Post##) -
(##- .
[##. /
FromBody##/ 7
]##7 8
Earning##9 @
earning##A H
)##H I
{$$ 	
var%% 
result%% 
=%% 
await%% 
_earningService%% .
.%%. /
RegisterEarning%%/ >
(%%> ?
earning%%? F
)%%F G
;%%G H
return'' 
Ok'' 
('' 
result'' 
)'' 
;'' 
}(( 	
}** 
}++ õ
DD:\_lab\carllet-mvp\Application\Controllers\HealthcheckController.cs
	namespace 	
Application
 
. 
Controllers !
{ 
[ 
Route 

(
 
$str 
) 
] 
[ 
ApiController 
] 
public 

class !
HealthcheckController &
:' (
ControllerBase) 7
{ 
[		 	
HttpGet			 
]		 
public

 
IActionResult

 
Get

  
(

  !
)

! "
{ 	
return 
Ok 
( 
$str 
) 
; 
} 	
} 
} Ž-
=D:\_lab\carllet-mvp\Application\Controllers\UserController.cs
	namespace 	
Application
 
. 
Controllers !
{ 
[		 
Route		 

(		
 
$str		 
)		 
]		 
[

 
ApiController

 
]

 
public 

class 
UserController 
:  !
ControllerBase" 0
{ 
private 
readonly 
IUserService %
_userService& 2
;2 3
private 
const 
int 

WorkFactor $
=% &
$num' (
;( )
public 
UserController 
( 
IUserService *
userService+ 6
)6 7
{ 	
_userService 
= 
userService &
;& '
} 	
[   	
HttpGet  	 
]   
public!! 
async!! 
Task!! 
<!! 
IActionResult!! '
>!!' (
Get!!) ,
(!!, -
)!!- .
{"" 	
var## 
result## 
=## 
await## 
_userService## +
.##+ ,
GetUserList##, 7
(##7 8
)##8 9
;##9 :
if%% 
(%% 
result%% 
==%% 
null%% 
)%% 
return&& 

BadRequest&& !
(&&! "
new&&" %
{&&& '
message&&( /
=&&0 1
$str&&2 O
}&&P Q
)&&Q R
;&&R S
return(( 
Ok(( 
((( 
result(( 
)(( 
;(( 
})) 	
[44 	
HttpPost44	 
(44 
$str44 
)44 
]44 
public55 
async55 
Task55 
<55 
IActionResult55 '
>55' (
Login55) .
(55. /
[55/ 0
FromBody550 8
]558 9
LoginRequest55: F
model55G L
)55L M
{66 	
var77 
result77 
=77 
await77 
_userService77 +
.77+ ,
Login77, 1
(771 2
model772 7
.777 8
Email778 =
,77= >
model77? D
.77D E
Password77E M
)77M N
;77N O
return99 
Ok99 
(99 
result99 
)99 
;99 
}:: 	
[GG 	
HttpGetGG	 
(GG 
$strGG 
)GG 
]GG 
publicHH 
asyncHH 
TaskHH 
<HH 
IActionResultHH '
>HH' (
GetUserHH) 0
(HH0 1
GuidHH1 5
idHH6 8
)HH8 9
{II 	
varJJ 
resultJJ 
=JJ 
awaitJJ 
_userServiceJJ +
.JJ+ ,
GetUserJJ, 3
(JJ3 4
idJJ4 6
)JJ6 7
;JJ7 8
returnLL 
OkLL 
(LL 
resultLL 
)LL 
;LL 
}MM 	
[UU 	
HttpPostUU	 
]UU 
publicVV 
asyncVV 
TaskVV 
<VV 
IActionResultVV '
>VV' (
PostVV) -
(VV- .
[VV. /
FromBodyVV/ 7
]VV7 8
NewUserRequestVV9 G
requestVVH O
)VVO P
{WW 	
UserXX 
userXX 
=XX 
newXX 
UserXX  
(XX  !
)XX! "
{YY 
NameZZ 
=ZZ 
requestZZ 
.ZZ 
NameZZ #
,ZZ# $
Email[[ 
=[[ 
request[[ 
.[[  
Email[[  %
,[[% &
Password\\ 
=\\ 
request\\ "
.\\" #
Password\\# +
,\\+ ,
DeviceId]] 
=]] 
request]] "
.]]" #
DeviceId]]# +
}^^ 
;^^ 
var`` 
result`` 
=`` 
await`` 
_userService`` +
.``+ ,
Register``, 4
(``4 5
user``5 9
)``9 :
;``: ;
returnbb 
Okbb 
(bb 
resultbb 
)bb 
;bb 
}cc 	
[jj 	
HttpPutjj	 
(jj 
$strjj 
)jj 
]jj 
publickk 
asynckk 
Taskkk 
<kk 
IActionResultkk '
>kk' (
Putkk) ,
(kk, -
[kk- .
FromBodykk. 6
]kk6 7
Userkk8 <
userkk= A
)kkA B
{ll 	
varmm 
resultmm 
=mm 
awaitmm 
_userServicemm +
.mm+ ,
Updatemm, 2
(mm2 3
usermm3 7
)mm7 8
;mm8 9
returnoo 
Okoo 
(oo 
resultoo 
)oo 
;oo 
}pp 	
[
 	

HttpDelete
	 
(
 
$str
 
)
 
]
 
public
‚‚ 
async
‚‚ 
Task
‚‚ 
<
‚‚ 
IActionResult
‚‚ '
>
‚‚' (

DeleteUser
‚‚) 3
(
‚‚3 4
Guid
‚‚4 8
id
‚‚9 ;
)
‚‚; <
{
ƒƒ 	
var
„„ 
result
„„ 
=
„„ 
await
„„ 
_userService
„„ +
.
„„+ ,

DeleteUser
„„, 6
(
„„6 7
id
„„7 9
)
„„9 :
;
„„: ;
return
†† 
Ok
†† 
(
†† 
result
†† 
)
†† 
;
†† 
}
‡‡ 	
}
ˆˆ 
}ŠŠ â'
@D:\_lab\carllet-mvp\Application\Controllers\VehicleController.cs
	namespace 	
Application
 
. 
Controllers !
{ 
[		 
Route		 

(		
 
$str		 
)		 
]		 
[

 
ApiController

 
]

 
public 

class 
VehicleController "
:# $
ControllerBase% 3
{ 
private 
readonly 
IVehicleService (
_vehicleService) 8
;8 9
public 
VehicleController  
(  !
IVehicleService! 0
vehicleService1 ?
)? @
{ 	
_vehicleService 
= 
vehicleService ,
;, -
} 	
[ 	
HttpGet	 
] 
public   
async   
Task   
<   
IActionResult   '
>  ' (
Get  ) ,
(  , -
)  - .
{!! 	
var"" 
result"" 
="" 
await"" 
_vehicleService"" .
."". /
GetVehicleList""/ =
(""= >
)""> ?
;""? @
if$$ 
($$ 
result$$ 
==$$ 
null$$ 
)$$ 
{%% 
return&& 
NotFound&& 
(&&  
)&&  !
;&&! "
}'' 
return)) 
Ok)) 
()) 
result)) 
))) 
;)) 
}** 	
[77 	
HttpGet77	 
(77 
$str77 
)77 
]77 
public88 
async88 
Task88 
<88 
IActionResult88 '
>88' (

GetVehicle88) 3
(883 4
int884 7
id888 :
)88: ;
{99 	
var:: 
result:: 
=:: 
await:: 
_vehicleService:: .
.::. /
GetVehicleById::/ =
(::= >
id::> @
)::@ A
;::A B
return<< 
Ok<< 
(<< 
result<< 
)<< 
;<< 
}== 	
[JJ 	
HttpGetJJ	 
(JJ 
$strJJ $
)JJ$ %
]JJ% &
publicKK 
asyncKK 
TaskKK 
<KK 
IActionResultKK '
>KK' (
GetVehicleByOwnerKK) :
(KK: ;
GuidKK; ?
ownerIdKK@ G
)KKG H
{LL 	
varMM 
resultMM 
=MM 
awaitMM 
_vehicleServiceMM .
.MM. /
GetVehicleByOwnerMM/ @
(MM@ A
ownerIdMMA H
)MMH I
;MMI J
ifOO 
(OO 
resultOO 
==OO 
nullOO 
)OO 
returnPP 
NotFoundPP 
(PP  
)PP  !
;PP! "
returnRR 
OkRR 
(RR 
resultRR 
)RR 
;RR 
}SS 	
[`` 	
HttpPost``	 
]`` 
publicaa 
asyncaa 
Taskaa 
<aa 
IActionResultaa '
>aa' (
Postaa) -
(aa- .
[aa. /
FromBodyaa/ 7
]aa7 8
NewVehicleRequestaa9 J
requestaaK R
)aaR S
{bb 	
Vehiclecc 
vehiclecc 
=cc 
newcc !
Vehiclecc" )
(cc) *
)cc* +
{dd 
Brandee 
=ee 
requestee 
.ee  
Brandee  %
,ee% &
Modelff 
=ff 
requestff 
.ff  
Modelff  %
,ff% &
FabricationDategg 
=gg  !
requestgg" )
.gg) *
FabricationYeargg* 9
,gg9 :
Odometerhh 
=hh 
requesthh "
.hh" #
Odometerhh# +
,hh+ ,
rentedii 
=ii 
requestii  
.ii  !
Rentedii! '
}jj 
;jj 
varll 
resultll 
=ll 
awaitll 
_vehicleServicell .
.ll. /
CreateVehiclell/ <
(ll< =
vehiclell= D
)llD E
;llE F
returnnn 
Oknn 
(nn 
resultnn 
)nn 
;nn 
}oo 	
[|| 	

HttpDelete||	 
(|| 
$str|| 
)|| 
]|| 
public}} 
async}} 
Task}} 
<}} 
IActionResult}} '
>}}' (
DeleteVehicle}}) 6
(}}6 7
int}}7 :
id}}; =
)}}= >
{~~ 	
var 
result 
= 
await 
_vehicleService .
.. /
DeleteVehicle/ <
(< =
id= ?
)? @
;@ A
return
 
Ok
 
(
 
result
 
)
 
;
 
}
‚‚ 	
}
„„ 
}…… “(
*D:\_lab\carllet-mvp\Application\Program.cs
var		 
builder		 
=		 
WebApplication		 
.		 
CreateBuilder		 *
(		* +
args		+ /
)		/ 0
;		0 1
builder 
. 
Services 
. 
	AddScoped 
< 
IAuthService '
,' (
AuthService) 4
>4 5
(5 6
)6 7
;7 8
builder 
. 
Services 
. 
	AddScoped 
< 
IUserService '
,' (
UserService) 4
>4 5
(5 6
)6 7
;7 8
builder 
. 
Services 
. 
	AddScoped 
< 
IVehicleService *
,* +
VehicleService, :
>: ;
(; <
)< =
;= >
builder 
. 
Services 
. 
	AddScoped 
< 
ICourseService )
,) *
CourseService+ 8
>8 9
(9 :
): ;
;; <
builder 
. 
Services 
. 
	AddScoped 
< 
IEarningService *
,* +
EarningService, :
>: ;
(; <
)< =
;= >
builder 
. 
Services 
. 
AddSingleton 
< 
IConfiguration ,
>, -
(- .
builder. 5
.5 6
Configuration6 C
)C D
;D E
builder 
. 
Services 
. 
AddControllers 
(  
)  !
;! "
builder 
. 
Services 
. 
AddDbContext 
< 
CarlletDbContext .
>. /
(/ 0
options0 7
=>8 :
options; B
.B C
	UseNpgsqlC L
(L M
builderM T
.T U
ConfigurationU b
.b c
GetConnectionStringc v
(v w
$strw 
)	 €
)
€ 
)
 ‚
;
‚ ƒ
builder 
. 
Services 
. #
AddEndpointsApiExplorer (
(( )
)) *
;* +
builder 
. 
Services 
. 
AddSwaggerGen 
( 
options &
=>' )
{ 
options 
. 

SwaggerDoc 
( 
$str 
, 
new  
OpenApiInfo! ,
{ 
Version 
= 
$str 
, 
Title 
= 
$str  
,  !
Description 
= 
$str	 …
,
… †
TermsOfService 
= 
new 
Uri  
(  !
$str! <
)< =
,= >
Contact   
=   
new   
OpenApiContact   $
{!! 	
Name"" 
="" 
$str"" #
,""# $
Url## 
=## 
new## 
Uri## 
(## 
$str## 7
)##7 8
}$$ 	
,$$	 

License%% 
=%% 
new%% 
OpenApiLicense%% $
{&& 	
Name'' 
='' 
$str'' $
,''$ %
Url(( 
=(( 
new(( 
Uri(( 
((( 
$str(( 7
)((7 8
})) 	
}** 
)** 
;** 
var,, 
xmlFilename,, 
=,, 
$",, 
{,, 
Assembly,, !
.,,! " 
GetExecutingAssembly,," 6
(,,6 7
),,7 8
.,,8 9
GetName,,9 @
(,,@ A
),,A B
.,,B C
Name,,C G
},,G H
$str,,H L
",,L M
;,,M N
options-- 
.-- 
IncludeXmlComments-- 
(-- 
Path-- #
.--# $
Combine--$ +
(--+ ,

AppContext--, 6
.--6 7
BaseDirectory--7 D
,--D E
xmlFilename--F Q
)--Q R
)--R S
;--S T
}.. 
).. 
;.. 
var22 
app22 
=22 	
builder22
 
.22 
Build22 
(22 
)22 
;22 
app77 
.77 

UseSwagger77 
(77 
)77 
;77 
app88 
.88 
UseSwaggerUI88 
(88 
)88 
;88 
app== 
.== 
UseAuthorization== 
(== 
)== 
;== 
appAA 
.AA 
MapControllersAA 
(AA 
)AA 
;AA 
appDD 
.DD 
RunDD 
(DD 
)DD 	
;DD	 
¢
CD:\_lab\carllet-mvp\Application\Requests\Course\NewCourseRequest.cs
	namespace 	
Application
 
. 
Requests 
. 
Course %
{ 
public 

class 
NewCourseRequest !
{ 
public 
Guid 
? 
OwnerId 
{ 
get "
;" #
set$ '
;' (
}) *
public 
float 
CourseLength !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
DateTime 
CourseEndTime %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
} 
}		 á
=D:\_lab\carllet-mvp\Application\Requests\User\LoginRequest.cs
	namespace 	
Application
 
. 
Requests 
. 
User #
{ 
public 

class 
LoginRequest 
{ 
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
} 
} ™
?D:\_lab\carllet-mvp\Application\Requests\User\NewUserRequest.cs
	namespace 	
Application
 
. 
Requests 
. 
User #
{ 
public 

class 
NewUserRequest 
{ 
public 
string 
Name 
{ 
get  
;  !
set" %
;% &
}' (
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
DeviceId 
{  
get! $
;$ %
set& )
;) *
}+ ,
}		 
}

 Á
ED:\_lab\carllet-mvp\Application\Requests\Vehicle\NewVehicleRequest.cs
	namespace 	
Application
 
. 
Requests 
. 
Vehicle &
{ 
public 

class 
NewVehicleRequest "
{ 
public 
string 
Brand 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
Model 
{ 
get !
;! "
set# &
;& '
}( )
public 
short 
FabricationYear $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 
int 
Odometer 
{ 
get !
;! "
set# &
;& '
}( )
public		 
bool		 
Rented		 
{		 
get		  
;		  !
set		" %
;		% &
}		' (
}

 
} 